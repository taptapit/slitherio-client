var __reflect=this&&this.__reflect||function(e,t,n){e.__class__=t,n?n.push(t):n=[t],e.__types__=e.__types__?n.concat(e.__types__):n},__extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a]);n.prototype=t.prototype,e.prototype=new n},__awaiter=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function s(e){try{h(a.next(e))}catch(t){r(t)}}function o(e){try{h(a["throw"](e))}catch(t){r(t)}}function h(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,o)}h((a=a.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return a([e,t])}}function a(n){if(i)throw new TypeError("Generator is already executing.");for(;h;)try{if(i=1,r&&(s=r[2&n[0]?"return":n[0]?"throw":"next"])&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[0,s.value]),n[0]){case 0:case 1:s=n;break;case 4:return h.label++,{value:n[1],done:!1};case 5:h.label++,r=n[1],n=[0];continue;case 7:n=h.ops.pop(),h.trys.pop();continue;default:if(s=h.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){h=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){h.label=n[1];break}if(6===n[0]&&h.label<s[1]){h.label=s[1],s=n;break}if(s&&h.label<s[2]){h.label=s[2],h.ops.push(n);break}s[2]&&h.ops.pop(),h.trys.pop();continue}n=t.call(e,h)}catch(a){n=[6,a],r=0}finally{i=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,r,s,o,h={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o},game;!function(e){var t;!function(e){var t=function(){function e(){}return e.construct=function(e){return new e},e.get=function(t){var n=this.pools[t]=this.pools[t]?this.pools[t]:[];return n.length>0?n.pop():e.construct(t)},e.release=function(e,t){var n=this.pools[e];n.push(t)},e.pools=new Object,e}();e.ObjectPool=t,__reflect(t.prototype,"game.utils.ObjectPool")}(t=e.utils||(e.utils={}))}(game||(game={}));var game;!function(e){var t;!function(e){var t=function(){function t(){}return t.random=function(){return t.COLORS[Math.floor(Math.random()*t.COLORS.length)]},t.lerp=function(t,n,a){return(e.MathUtils.lerp(t>>16,n>>16,a)<<16&16711680)+(e.MathUtils.lerp(t>>8&255,n>>8&255,a)<<8&65280)+e.MathUtils.lerp(255&t,255&n,a)},t.COLORS=[2565927,6369328,4737169,24624,7091045,3080192,15934,7955456],t}();e.ColorUtils=t,__reflect(t.prototype,"game.utils.ColorUtils")}(t=e.utils||(e.utils={}))}(game||(game={}));var game;!function(e){var t;!function(e){var t=function(){function e(){}return e.CREATE_FOOD="CREATE_FOOD",e}();e.GameEvent=t,__reflect(t.prototype,"game.event.GameEvent")}(t=e.event||(e.event={}))}(game||(game={}));var game;!function(e){var t;!function(e){var t=function(){function e(){}return e.addListener=function(e,t,n){var a=this.listeners[e]=this.listeners[e]?this.listeners[e]:[];a.push({callback:t,thisObject:n})},e.removeListener=function(e,t){var n=this.listeners[e];if(!n)return void console.warn("EventCenter doesn't exist listener type:"+e);for(var a=0;a<n.length;a++)if(n[a].callback&&n[a].callback==t)return n.splice(a,1),!0;return!1},e.dispatch=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var a=this.listeners[e];if(a)for(var i=0;i<a.length;i++){var r=a[i].callback,s=a[i].thisObject;r&&r.call.apply(r,[s].concat(t))}},e.listeners={},e}();e.EventCenter=t,__reflect(t.prototype,"game.event.EventCenter")}(t=e.event||(e.event={}))}(game||(game={}));var game;!function(e){var t;!function(t){var n=function(){function t(){this.ranks=[],this.snakes={},this.foods={}}return t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},t.prototype.sortSnake=function(e,t){return e.energy>t.energy?-1:e.energy<t.energy?1:0},t.prototype.update=function(){var e=t.getInstance().snakes,n=t.getInstance().foods;this.ranks&&this.ranks.splice(0,this.ranks.length);for(var a in e){var i=e[a];this.history=!this.history||i.energy>this.history.energy?i:this.history,this.ranks.push(i),i.update()}this.ranks.sort(this.sortSnake);for(var a in n)n[a].update()},t.prototype.add=function(t){if(t instanceof e.Snake){var n=t;this.snakes[n.id]=n}else if(t instanceof e.Food){var a=t;this.foods[a.id]=a}},t.prototype.remove=function(t){if(t instanceof e.Snake){var n=t;this.snakes[n.id]=null,delete this.snakes[n.id]}else if(t instanceof e.Food){var a=t;this.foods[a.id]=null,delete this.foods[a.id]}},t.prototype.get=function(t){return t instanceof e.Snake?this.snakes[t.id]:t instanceof e.Food?this.foods[t.id]:"number"==typeof t?this.snakes[t]?this.snakes[t]:this.foods[t]?this.foods[t]:null:void 0},t.UUID=0,t}();t.GameObjectManager=n,__reflect(n.prototype,"game.data.GameObjectManager")}(t=e.data||(e.data={}))}(game||(game={}));var ObjectPool=game.utils.ObjectPool,GameObjectManager=game.data.GameObjectManager,EventCenter=game.event.EventCenter,GameEvent=game.event.GameEvent,ColorUtils=game.utils.ColorUtils,game;!function(e){var t=function(){function t(n,a,i,r,s,o,h,c){void 0===o&&(o=null),void 0===h&&(h=0),void 0===c&&(c=0),this.id=n,this.name=a,this.position=i,this.angle=r,this.targetAngle=r,this.velocity=s,this.velocityTurnAngle=t.velocity2TurnAngle(this.velocity),this.points=o,this.color=h,this.energy=c,this.length=t.energy2Length(c),this.scale=t.length2Scale(this.length),this.scaleTurnAngle=t.scale2TurnAngle(this.scale),this.renderer=new e.renderer.SnakeRenderer(this)}return Object.defineProperty(t.prototype,"hasViewStateChanged",{get:function(){if(void 0==this.$hasViewStateChanged){for(var e=0;e<this.points.length;e++)this.points[e].hasViewStateChanged&&(this.$hasViewStateChanged=!0);void 0==this.$hasViewStateChanged&&(this.$hasViewStateChanged=!1)}return this.$hasViewStateChanged},set:function(e){this.$hasViewStateChanged=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isInView",{get:function(){if(void 0==this.$isInView){for(var e=0;e<this.points.length;e++)this.points[e].isInView&&(this.$isInView=!0);void 0==this.$isInView&&(this.$isInView=!1)}return this.$isInView},enumerable:!0,configurable:!0}),t.skinColor=function(e,t){var n=e,a=ColorUtils.lerp(n,12895428,.7),i=526344,r=t*i/Math.abs(a-n),s=Math.floor(r)%2==0;return r-=Math.floor(r),s?ColorUtils.lerp(n,a,r):ColorUtils.lerp(a,n,r)},t.length2Scale=function(e){return e-=this.BORN_BODY_LENGTH,Math.min(this.MAX_SCALE,this.BORN_SCALE+e/100)},t.scale2TurnAngle=function(e){return.13+.87*Math.pow((this.BORN_SCALE+this.MAX_SCALE-e)/this.MAX_SCALE,2)},t.velocity2TurnAngle=function(e){return e*this.VELOCITY_TO_TURN_ANGLE},t.energy2Length=function(e){return Math.floor(e/t.ENERGY_PER_POINT)},t.prototype.radius=function(){return t.BODY_SIZE*this.scale},t.prototype.dispose=function(){this.ai=null,this.renderer.parent&&GameLayerManager.getInstance().snakeLayer.removeChild(this.renderer),GameObjectManager.getInstance().remove(this)},t.prototype.hitTest=function(n){if(n instanceof e.SnakePoint){var a=n,i=GameObjectManager.getInstance().get(a.id);return i&&!i.dead&&Math.pow(this.position.x-a.x,2)+Math.pow(this.position.y-a.y,2)<Math.pow(this.radius()+i.radius(),2)}if(n instanceof e.Food){var r=n;return Math.pow(this.position.x-r.position.x,2)+Math.pow(this.position.y-r.position.y,2)<Math.pow(this.radius()+r.radius()+t.FOOD_DETECT_DISTANCE,2)}console.error("snake hitTest on unkown type target"+n)},t.prototype.die=function(){for(this.dead=!0,this.dispose();this.points.length>0;){var n=this.points.pop();ObjectPool.release(e.SnakePoint,n),EventCenter.dispatch(GameEvent.CREATE_FOOD,n.x,n.y,.5*t.ENERGY_PER_POINT,n.color)}},t.prototype.eat=function(e){e.eatBy(this),this.energy+=e.energy,this.length=t.energy2Length(this.energy),this.scale=t.length2Scale(this.length),this.scaleTurnAngle=t.scale2TurnAngle(this.scale)},t.prototype.update=function(){this.$isInView=void 0;var t=e.Time.deltaTime;this.updateNameAlpha(),this.updateDying(t),this.updateEnergy(t),this.turn(t),this.move(t)},t.prototype.updateNameAlpha=function(){},t.prototype.updateDying=function(e){this.dead&&(this.dyingAlpha+=.02*e,this.dyingAlpha>=1&&delete GameObjectManager.getInstance().snakes[this.id])},t.prototype.updateEnergy=function(n){if(this.isAccelerate){var a=this.energy-n*t.ENERGY_SPEND_PER_SECOND>t.ENERGY_LIMIT_FOR_ACCELERATE;if(a)for(this.isAccelerate=!0,this.energy-=n*t.ENERGY_SPEND_PER_SECOND,this.length=t.energy2Length(this.energy),this.scale=t.length2Scale(this.length),this.scaleTurnAngle=t.scale2TurnAngle(this.scale);this.points.length>this.length;){var i=this.points.pop();ObjectPool.release(e.SnakePoint,i),EventCenter.dispatch(GameEvent.CREATE_FOOD,i.x,i.y,.5*t.ENERGY_PER_POINT,i.color)}else this.isAccelerate=!1}},t.prototype.clamp=function(e,t,n){return t>e?e+=n-t:e>n?e-=n-t:e},t.prototype.turn=function(e){this.angle=this.clamp((this.angle+Math.PI)%(2*Math.PI),-Math.PI,Math.PI)-Math.PI,this.targetAngle=this.clamp((this.targetAngle+Math.PI)%(2*Math.PI),-Math.PI,Math.PI)-Math.PI;var t=e*this.scaleTurnAngle*this.velocityTurnAngle;t=Math.min(t,Math.abs(this.targetAngle-this.angle)),Math.abs(this.angle-this.targetAngle)>Math.PI?this.targetAngle>this.angle?this.angle-=t:this.angle+=t:this.targetAngle>this.angle?this.angle+=t:this.angle-=t},t.prototype.move=function(n){var a=this.velocity*n,i=this.scale*t.BODY_POINT_DELTA_SCALE,r=Math.min(1,a/i);if(this.position.x=this.position.x+Math.cos(this.angle)*a,this.position.y=this.position.y+Math.sin(this.angle)*a,this.points.length>this.length)ObjectPool.release(e.SnakePoint,this.points.pop());else{if(this.points.length<this.length){var s=ObjectPool.get(e.SnakePoint),o=this.points[this.points.length-1];s.id=this.id,s.x=o?o.x:0,s.y=o?o.y:0,s.index=this.points.length,s.color=t.skinColor(this.color,this.points.length),this.points.push(s)}for(var h=this.points.length-1;h>0;h--){var c=this.points[h],l=this.points[h-1];c.x=c.x+(l.x-c.x)*r,c.y=c.y+(l.y-c.y)*r}this.points[0].x=this.position.x,this.points[0].y=this.position.y}},t.prototype.render=function(){this.isInView?this.renderer&&(this.renderer.parent||GameLayerManager.getInstance().snakeLayer.addChild(this.renderer),this.renderer.render()):this.renderer&&this.renderer.parent&&GameLayerManager.getInstance().snakeLayer.removeChild(this.renderer)},t.BODY_SIZE=100,t.BORN_BODY_LENGTH=6,t.BORN_SCALE=.2,t.MAX_SCALE=1,t.VELOCITY_TO_TURN_ANGLE=.1,t.VELOCITY_NORMAL=200,t.VELOCITY_FAST=2*t.VELOCITY_NORMAL,t.BODY_POINT_DELTA_SCALE=50,t.ENERGY_PER_POINT=20,t.ENERGY_SPEND_PER_SECOND=5*t.ENERGY_PER_POINT,t.ENERGY_LIMIT_FOR_ACCELERATE=5*t.ENERGY_PER_POINT,t.FOOD_DETECT_DISTANCE=50,t}();e.Snake=t,__reflect(t.prototype,"game.Snake")}(game||(game={}));var game;!function(e){var t;!function(t){var n=function(){function t(){}return t.update=function(){var t=WorldNodeManager.getInstance().nodes;for(var n in t){var a=t[n];for(var i in a.snakes){var r=a.snakes[i];if(r.ai&&(r.ai.tick+=e.Time.deltaTime,r.ai.moveable)){for(var s=0;9>=s;s++){var o=WorldNodeManager.getInstance().get(a.column-1+s%3,a.row-1+Math.floor(s/3));if(o){for(var h in o.foods){var c=o.foods[h];if(!r.dead&&!c.eaten){r.ai.eat(c);break}}for(var h in o.snakesPoints){var l=o.snakesPoints[h];if(r.id!=l.id&&!r.dead){var d=GameObjectManager.getInstance().get(l.id);if(d&&!d.dead){r.ai.dodgeSnake(l);break}}}for(var h in o.snakes){var d=o.snakes[h];if(r.id!=d.id&&!r.dead&&!d.dead){r.ai.kill(d);break}}}}r.ai.dodgeWall()}}}},t}();t.SnakeAICenter=n,__reflect(n.prototype,"game.ai.SnakeAICenter")}(t=e.ai||(e.ai={}))}(game||(game={}));var game;!function(e){var t;!function(e){var t=function(){function t(){this.nodes=new Object}return t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},t.prototype.get=function(t,n,a){void 0===a&&(a=!1);var i=1e4*t+n,r=this.nodes[i];return!r&&a&&(r=new e.WorldNode,r.x=t*e.WorldNode.SIDE_LENGTH,r.y=n*e.WorldNode.SIDE_LENGTH,r.row=n,r.column=t,r.id=i,this.nodes[i]=r),r},t}();e.WorldNodeManager=t,__reflect(t.prototype,"game.data.WorldNodeManager")}(t=e.data||(e.data={}))}(game||(game={}));var game;!function(e){var t;!function(t){var n=function(){function t(){}return t.render=function(){if(this.tick-=e.Time.deltaTime,!(this.tick>0)){this.tick=t.UPDATE_FREQUENCY;for(var n=GameObjectManager.getInstance().ranks,a=GameObjectManager.getInstance().history,i=egret.MainContext.instance.stage.stageWidth,r=egret.MainContext.instance.stage.stageHeight,s=(new egret.Bitmap,0);10>s;s++){var o=s<n.length?n[s]:null,h=i-300,c=0;if(o){var l=.9*(.2+.8*Math.pow(1-s/10,2)),d=e.Snake.skinColor(o.color,0);this.drawText("Rank1_"+s,"#"+(s+1),h+0,c+14*s,11,d,l),this.drawText("Rank2_"+s,o.name,h+28,c+14*s,11,d,l),this.drawText("Rank3_"+s,Math.floor(o.energy),h+200,c+14*s,11,d,l)}else this.clear("Rank1_"+s),this.clear("Rank2_"+s),this.clear("Rank3_"+s)}var g=0,u=r-40;this.drawText("ScoreText","当前得分：",g,u,12,16777215,.6),this.drawText("Score",Math.floor(GameObjectManager.getInstance().player.energy),g+50,u,14,16777215,1),this.drawText("Rank","当前排名："+GameObjectManager.getInstance().ranks.indexOf(GameObjectManager.getInstance().player)+"/"+GameObjectManager.getInstance().ranks.length,g,u+18,12,16777215,.6),a?this.drawText("History",a.name+"创造了最好成绩："+Math.floor(a.energy),0,0,12,e.Snake.skinColor(a.color,0),1):this.clear("History")}},t.clear=function(e){var n=t.textFields[e];n&&(n.parent&&n.parent.removeChild(n),t.textFields[e]=null,delete t.textFields[e])},t.drawText=function(e,n,a,i,r,s,o){var h=t.textFields[e];h||(h=new egret.TextField,h.textAlign=egret.HorizontalAlign.LEFT,t.textFields[e]=h),h.text=n,h.x=a,h.y=i,h.size=r,h.textColor=s,h.alpha=o,h.parent||GameLayerManager.getInstance().aboveUILayer.addChild(h)},t.textFields=new Object,t.UPDATE_FREQUENCY=1,t.tick=0,t}();t.GameHUDRenderer=n,__reflect(n.prototype,"game.renderer.GameHUDRenderer")}(t=e.renderer||(e.renderer={}))}(game||(game={}));var game;!function(e){var t;!function(t){var n=function(){function n(){this.snakes=[],this.snakesPoints=[],this.foods=[]}return n.prototype.update=function(){var t=egret.Rectangle.create();t.setTo(this.x,this.y,n.SIDE_LENGTH,n.SIDE_LENGTH),this.isInView=e.Camera.isInViewPort(t),egret.Rectangle.release(t);for(var a in this.snakesPoints){var i=this.snakesPoints[a];i.isInView!=this.isInView&&(i.hasViewStateChanged=!0),i.isInView=this.isInView}for(var a in this.foods){var r=this.foods[a];r.isInView=this.isInView}},n.prototype.reset=function(){this.snakes&&this.snakes.splice(0,this.snakes.length),this.snakesPoints&&this.snakesPoints.splice(0,this.snakesPoints.length),this.foods&&this.foods.splice(0,this.foods.length),this.gizimos&&this.gizimos.parent&&this.gizimos.parent.removeChild(this.gizimos),t.WorldNodeManager.getInstance().nodes[this.id]=null,delete t.WorldNodeManager.getInstance().nodes[this.id]},n.prototype.drawGizimos=function(){this.gizimos||(this.gizimos=new egret.Sprite,this.gizimos.x=this.x,this.gizimos.y=this.y,this.gizimos.graphics.beginFill(9140574),this.gizimos.graphics.drawRect(0,0,n.SIDE_LENGTH,n.SIDE_LENGTH),this.gizimos.graphics.endFill(),this.gizimos.graphics.beginFill(9136489),this.gizimos.graphics.drawRect(0,0,n.SIDE_LENGTH-4,n.SIDE_LENGTH-4),this.gizimos.graphics.endFill()),this.isInView?this.gizimos.parent||GameLayerManager.getInstance().scene.addChildAt(this.gizimos,0):this.gizimos&&this.gizimos.parent&&this.gizimos.parent.removeChild(this.gizimos)},n.SIDE_LENGTH=2*e.Snake.BODY_SIZE*e.Snake.MAX_SCALE,n}();t.WorldNode=n,__reflect(n.prototype,"game.data.WorldNode")}(t=e.data||(e.data={}))}(game||(game={}));var game;!function(e){var t;!function(e){var t=function(){function e(){}return e.getInstance=function(){return this.instance||(this.instance=new e),this.instance},e}();e.GameLayerManager=t,__reflect(t.prototype,"game.utils.GameLayerManager")}(t=e.utils||(e.utils={}))}(game||(game={}));var game;!function(e){var t;!function(t){var n=function(){function t(e,t){void 0===t&&(t=1),this.tick=0,this.snake=e,this.level=t}return Object.defineProperty(t.prototype,"moveable",{get:function(){return this.tick>this.level*t.ACTION_TIME_INTERVAL},enumerable:!0,configurable:!0}),t.prototype.eat=function(e){this.tick=0,this.snake.targetAngle=Math.atan2(e.position.y-this.snake.position.y,e.position.x-this.snake.position.x)},t.prototype.dodgeWall=function(){this.tick=0,Math.pow(this.snake.position.x,2)+Math.pow(this.snake.position.y,2)>Math.pow(e.World.RADIUS-500,2)&&(this.snake.targetAngle=Math.atan2(this.snake.position.y,this.snake.position.x)+Math.PI)},t.prototype.dodgeSnake=function(e){this.tick=0,this.snake.targetAngle=Math.atan2(e.y-this.snake.position.y,e.x-this.snake.position.x)+Math.PI},t.prototype.kill=function(e){var t=this;this.tick=0,this.snake.targetAngle=Math.atan2(e.position.y-this.snake.position.y,e.position.x-this.snake.position.x),this.snake.isAccelerate=!0,setTimeout(function(){t.snake&&!t.snake.die&&(t.snake.isAccelerate=!1)},500)},t.ACTION_TIME_INTERVAL=1,t}();t.SnakeAI=n,__reflect(n.prototype,"game.ai.SnakeAI")}(t=e.ai||(e.ai={}))}(game||(game={}));var game;!function(e){var t;!function(e){var t=function(){function e(){}return e}();e.GameNetManager=t,__reflect(t.prototype,"game.net.GameNetManager")}(t=e.net||(e.net={}))}(game||(game={}));var game;!function(e){var t=function(t){function n(){var e=t.call(this)||this;return e.edges=[],e.grids=[],e.onAddToStage(),e}return __extends(n,t),n.prototype.onAddToStage=function(){for(var e=0;e<n.EDGE_SEGMENT_NUM;e++){var t=360*e/n.EDGE_SEGMENT_NUM,a=Math.cos(t*n.DEG_TO_RAD)*n.RADIUS,i=Math.sin(t*n.DEG_TO_RAD)*n.RADIUS,r=new egret.Shape;r.graphics.beginFill(n.EDGE_SEGMENT_COLOR,1),r.graphics.drawRect(.5*-n.EDGE_SEGMENT_WIDTH,.5*-n.EDGE_SEGMENT_HEIGHT,n.EDGE_SEGMENT_WIDTH,n.EDGE_SEGMENT_HEIGHT),r.graphics.endFill(),r.x=a,r.y=i,r.rotation=t+90,this.edges.push(r)}},n.prototype.render=function(){for(var t in this.edges){var a=this.edges[t],i=egret.Rectangle.create();i.setTo(this.x,this.y,n.EDGE_SEGMENT_WIDTH,n.EDGE_SEGMENT_WIDTH);var r=e.Camera.isInViewPort(i);egret.Rectangle.release(i),r&&!this.contains(a)?this.addChild(a):!r&&this.contains(a)&&this.removeChild(a)}var s=RES.getRes("background_jpg");n.GRID_WIDTH=n.GRID_WIDTH?n.GRID_WIDTH:s.textureWidth,n.GRID_HEIGHT=n.GRID_HEIGHT?n.GRID_HEIGHT:s.textureHeight;for(var o=e.Camera.viewPortRect,h=0,c=o.left;c<o.right+n.GRID_WIDTH;c+=n.GRID_WIDTH)for(var l=o.top;l<o.bottom+n.GRID_HEIGHT;l+=n.GRID_HEIGHT){this.grids[h]||(this.grids[h]=new egret.Bitmap(s));var d=this.grids[h];d.x=Math.floor(c/n.GRID_WIDTH)*n.GRID_WIDTH,d.y=Math.floor(l/n.GRID_HEIGHT)*n.GRID_HEIGHT,d.parent||this.addChild(d),h++}},n.EDGE_SEGMENT_WIDTH=2e3,n.EDGE_SEGMENT_HEIGHT=1e3,n.EDGE_SEGMENT_COLOR=2960685,n.EDGE_SEGMENT_NUM=120,n.RADIUS=1e4,n.DEG_TO_RAD=2*Math.PI/360,n}(egret.Sprite);e.World=t,__reflect(t.prototype,"game.World")}(game||(game={}));var Main=function(e){function t(){var t=e.call(this)||this;return t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAddToStage,t),t}return __extends(t,e),t.prototype.onAddToStage=function(e){egret.lifecycle.addLifecycleListener(function(e){e.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(e){console.log(e)})},t.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return[4,this.loadResource()];case 1:return n.sent(),this.createGameScene(),[4,RES.getResAsync("description_json")];case 2:return e=n.sent(),this.startAnimation(e),[4,platform.login()];case 3:return n.sent(),[4,platform.getUserInfo()];case 4:return t=n.sent(),console.log(t),[2]}})})},t.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),e=new LoadingUI,this.stage.addChild(e),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,RES.loadGroup("preload",0,e)];case 2:return n.sent(),this.stage.removeChild(e),[3,4];case 3:return t=n.sent(),console.error(t),[3,4];case 4:return[2]}})})},t.prototype.createGameScene=function(){new game.Game(this)},t.prototype.createBitmapByName=function(e){var t=new egret.Bitmap,n=RES.getRes(e);return t.texture=n,t},t.prototype.startAnimation=function(e){var t=this,n=new egret.HtmlTextParser,a=e.map(function(e){return n.parse(e)}),i=this.textfield,r=-1,s=function(){r++,r>=a.length&&(r=0);var e=a[r];i.textFlow=e;var n=egret.Tween.get(i);n.to({alpha:1},200),n.wait(2e3),n.to({alpha:0},200),n.call(s,t)};s()},t}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var game;!function(e){var t=function(){function e(){}return e}();e.SnakePoint=t,__reflect(t.prototype,"game.SnakePoint")}(game||(game={}));var game;!function(e){var t=function(){function t(){}return t.RandomCreate=function(){var t=(.9*Math.random(),Math.random()*Math.PI*2,new e.Snake(++GameObjectManager.UUID,GameObjectManager.UUID,egret.Point.create(Math.random()*e.World.RADIUS*.9,Math.random()*e.World.RADIUS*.9),Math.random()*Math.PI*2,e.Snake.VELOCITY_NORMAL,[],ColorUtils.random(),1200));return GameObjectManager.getInstance().add(t),t},t}();e.SnakeFactory=t,__reflect(t.prototype,"game.SnakeFactory")}(game||(game={}));var game;!function(e){var t=function(){function e(){egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this)}return e.getInstance=function(){return this.instance||(this.instance=new e),this.instance},e.prototype.IsDoubleClick=function(){var t=egret.getTimer(),n=!isNaN(this.lastClickTime)&&t-this.lastClickTime<e.DOUBLE_CLICK_INTERVAL;return this.lastClickTime=t,n},e.prototype.onTouchBegin=function(e){this.isDoubleClick=this.IsDoubleClick(),this.isTouching=!0,this.lastTouchX=e.stageX,this.lastTouchY=e.stageY},e.prototype.onTouchMove=function(t){var n=egret.getTimer();this.touchMoveTime=isNaN(this.touchMoveTime)?n:this.touchMoveTime,n-this.touchMoveTime>e.TOUCH_MOVE_INTERVAL&&(this.touchMoveTime=n,this.deltaX=t.stageX-this.lastTouchX,this.deltaY=t.stageY-this.lastTouchY,this.lastTouchX=t.stageX,this.lastTouchY=t.stageY)},e.prototype.onTouchEnd=function(e){this.isTouching=!1,this.isDoubleClick=!1},e.TOUCH_MOVE_INTERVAL=50,e.DOUBLE_CLICK_INTERVAL=400,e}();e.Input=t,__reflect(t.prototype,"game.Input")}(game||(game={}));var GameLayerManager=game.utils.GameLayerManager,WorldNodeManager=game.data.WorldNodeManager,WorldNode=game.data.WorldNode,SnakeAICenter=game.ai.SnakeAICenter,SnakeAI=game.ai.SnakeAI,GameHUDRenderer=game.renderer.GameHUDRenderer,game;!function(e){var t=function(t){function n(e){var n=t.call(this)||this;return e.addChild(n),n.setup(),n.start(),n}return __extends(n,t),n.prototype.send=function(){},n.prototype.recieved=function(){},n.prototype.setup=function(){e.Input.getInstance();var t=new egret.DisplayObjectContainer;t.touchEnabled=!1,this.addChild(t),GameLayerManager.getInstance().scene=t;var n=new e.World;n.touchEnabled=!1,t.addChild(n),GameLayerManager.getInstance().world=n;var a=new egret.DisplayObjectContainer;a.touchEnabled=!1,t.addChild(a),GameLayerManager.getInstance().underUILayer=a;var i=new egret.DisplayObjectContainer;i.touchEnabled=!1,t.addChild(i),GameLayerManager.getInstance().foodLayer=i;var r=new egret.DisplayObjectContainer;r.touchEnabled=!1,t.addChild(r),GameLayerManager.getInstance().foodBlendLayer=r;var s=new egret.DisplayObjectContainer;s.touchEnabled=!1,t.addChild(s),GameLayerManager.getInstance().snakeLayer=s;var o=new egret.DisplayObjectContainer;o.touchEnabled=!1,t.addChild(o),GameLayerManager.getInstance().snakeBlendLayer=o;var h=new egret.DisplayObjectContainer;h.touchEnabled=!1,this.addChild(h),GameLayerManager.getInstance().aboveUILayer=h,e.Camera.resize(egret.MainContext.instance.stage.stageWidth,egret.MainContext.instance.stage.stageHeight)},n.prototype.start=function(){var t=this;console.log("start"),e.Time.frameCount=0,this.addEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this),egret.lifecycle.onPause=function(){console.log("onPause"),t.lastTick=0/0,t.currentTick=0/0,t.removeEventListener(egret.Event.ENTER_FRAME,t.onEnterFrame,t)},egret.lifecycle.onResume=function(){console.log("onResume"),t.addEventListener(egret.Event.ENTER_FRAME,t.onEnterFrame,t)},this.player=e.SnakeFactory.RandomCreate(),GameObjectManager.getInstance().player=this.player,GameObjectManager.getInstance().add(this.player),EventCenter.addListener(GameEvent.CREATE_FOOD,this.createFood,this)},n.prototype.stop=function(){this.removeEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this),EventCenter.removeListener(GameEvent.CREATE_FOOD,this.createFood),egret.lifecycle.onPause=null,egret.lifecycle.onResume=null},n.prototype.createFood=function(t,n,a,i){e.FoodFactory.Create(t,n,a,i)},n.prototype.onEnterFrame=function(t){isNaN(this.lastTick)&&(this.lastTick=.001*egret.getTimer()),isNaN(this.currentTick)&&(this.currentTick=.001*egret.getTimer()),this.currentTick=.001*egret.getTimer(),this.deltaTime=this.currentTick-this.lastTick,this.lastTick=this.currentTick,e.Time.deltaTime=this.deltaTime,e.Time.frameCount+=1,this.update(),this.render()},n.prototype.update=function(){if(e.Camera.update(),this.player&&!this.player.dead){var t=e.FoodFactory.RandomCreate();t.energy=.1,this.player.eat(t)}Object.keys(GameObjectManager.getInstance().foods).length<1e3&&e.FoodFactory.RandomCreate(),this.updateMiniMap(),this.updateOperation(),GameObjectManager.getInstance().update(),this.updateWorldNode(),SnakeAICenter.update()},n.prototype.updateWorldNode=function(){var t=WorldNodeManager.getInstance().nodes,n=GameObjectManager.getInstance().snakes,a=GameObjectManager.getInstance().foods;for(var i in t)t[i].reset();for(var r in n){var s=n[r],o=WorldNodeManager.getInstance().get(Math.floor(s.position.x/WorldNode.SIDE_LENGTH),Math.floor(s.position.y/WorldNode.SIDE_LENGTH),!0);o.snakes.push(s);for(var h in s.points){var c=s.points[h],l=WorldNodeManager.getInstance().get(Math.floor(c.x/WorldNode.SIDE_LENGTH),Math.floor(c.y/WorldNode.SIDE_LENGTH),!0);l.snakesPoints.push(c)}}for(var r in a){var d=a[r],o=WorldNodeManager.getInstance().get(Math.floor(d.position.x/WorldNode.SIDE_LENGTH),Math.floor(d.position.y/WorldNode.SIDE_LENGTH),!0);o.foods.push(d)}for(var r in t)for(var o=t[r],g=0;g<o.snakes.length;g++){var s=o.snakes[g];s.dead||Math.pow(s.position.x,2)+Math.pow(s.position.y,2)>Math.pow(e.World.RADIUS-.5*e.World.EDGE_SEGMENT_HEIGHT-s.radius(),2)&&s.die();for(var u=0;9>=u;u++){var p=WorldNodeManager.getInstance().get(o.column-1+u%3,o.row-1+Math.floor(u/3));if(p){for(var f in p.foods){var d=p.foods[f];s.dead||d.eaten||!s.hitTest(d)||s.eat(d)}for(var m in p.snakesPoints){var c=p.snakesPoints[m];if(s.id!=c.id&&!s.dead&&s.hitTest(c))if(0==c.index){var v=GameObjectManager.getInstance().get(c.id);s.radius()>=v.radius()?v.die():s.die()}else s.die()}}}}for(var i in t)t[i].update()},n.prototype.updateOperation=function(){this.player&&!this.player.dead&&(this.lastDeltaX=this.deltaX,this.lastDeltaY=this.deltaY,this.deltaX=e.Input.getInstance().deltaX,this.deltaY=e.Input.getInstance().deltaY,(this.deltaX!=this.lastDeltaX||this.deltaY!=this.lastDeltaY)&&(this.player.targetAngle=Math.atan2(this.deltaY,this.deltaX)),this.player.isAccelerate=e.Input.getInstance().isDoubleClick,this.player.velocity=this.player.isAccelerate?e.Snake.VELOCITY_FAST:e.Snake.VELOCITY_NORMAL)},n.prototype.updateMiniMap=function(){},n.prototype.render=function(){GameHUDRenderer.render();var e=GameObjectManager.getInstance().snakes,t=GameObjectManager.getInstance().foods;for(var n in e){var a=e[n];a.render()}for(var n in t){var i=t[n];i.render()}GameLayerManager.getInstance().world.render();var r=WorldNodeManager.getInstance().nodes;for(var n in r)r[n].drawGizimos()},n}(egret.DisplayObjectContainer);e.Game=t,__reflect(t.prototype,"game.Game")}(game||(game={}));var game;!function(e){var t=function(){function t(){}return t.Create=function(t,n,a,i){void 0===i&&(i=0);var r=new e.Food(++GameObjectManager.UUID,t,n,a,i);return GameObjectManager.getInstance().add(r),r},t.RandomCreate=function(){var t=.9*Math.random(),n=Math.random()*Math.PI*2,a=e.World.RADIUS*t*Math.cos(n),i=e.World.RADIUS*t*Math.sin(n),r=Math.random()*e.Snake.ENERGY_PER_POINT*.5,s=new e.Food(++GameObjectManager.UUID,a,i,r,ColorUtils.random());return GameObjectManager.getInstance().add(s),s},t}();e.FoodFactory=t,__reflect(t.prototype,"game.FoodFactory")}(game||(game={}));var game;!function(e){var t=function(){function e(){}return e}();e.Time=t,__reflect(t.prototype,"game.Time")}(game||(game={}));var game;!function(e){var t;!function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n.data=e,n.touchEnabled=!1,n}return __extends(n,t),n.prototype.dispose=function(){this.parent&&this.parent.removeChild(this),this.blendRenderer&&this.blendRenderer.parent&&this.blendRenderer.parent.removeChild(this.blendRenderer)},n.prototype.render=function(){var t=this.data;if(this.renderer||(this.renderer=new egret.Sprite,this.renderer.graphics.beginFill(t.color),this.renderer.graphics.drawCircle(0,0,e.Snake.BODY_SIZE),this.renderer.graphics.endFill(),this.addChild(this.renderer)),this.renderer.scaleX=t.scale,this.renderer.scaleY=t.scale,this.renderer.x=t.position.x,this.renderer.y=t.position.y,!this.blendRenderer){var n=RES.getRes("blink_png");this.blendRenderer=new egret.Bitmap(n),this.blendRenderer.blendMode=egret.BlendMode.ADD,GameLayerManager.getInstance().foodBlendLayer.addChild(this.blendRenderer)}this.blendRenderer.alpha=.5*Math.cos(.1*e.Time.frameCount),this.blendRenderer.scaleX=t.scale,this.blendRenderer.scaleY=t.scale,this.blendRenderer.x=t.position.x-.5*this.blendRenderer.width*this.blendRenderer.scaleX,this.blendRenderer.y=t.position.y-.5*this.blendRenderer.height*this.blendRenderer.scaleY},n}(egret.DisplayObjectContainer);t.FoodRenderer=n,__reflect(n.prototype,"game.renderer.FoodRenderer")}(t=e.renderer||(e.renderer={}))}(game||(game={}));var game;!function(e){var t=function(){function t(n,a,i,r,s){this.id=n,this.position=new egret.Point(a,i),this.energy=r,this.scale=t.energy2Scale(r),this.color=s,this.eaten=!1,this.eatenBy=null,this.eatenAlpha=0,this.renderer=new e.renderer.FoodRenderer(this)}return t.energy2Scale=function(e){return.01*e},t.prototype.radius=function(){return e.Snake.BODY_SIZE*this.scale*.5},t.prototype.dispose=function(){this.renderer&&this.renderer.dispose(),GameObjectManager.getInstance().remove(this)},t.prototype.eatBy=function(e){this.eaten=!0,this.eatenBy=e,this.eatenAlpha=0,this.dispose()},t.prototype.update=function(){},t.prototype.render=function(){this.isInView?this.renderer&&(this.renderer.parent||GameLayerManager.getInstance().foodLayer.addChild(this.renderer),this.renderer.render()):this.renderer.parent&&GameLayerManager.getInstance().foodLayer.removeChild(this.renderer)},t}();e.Food=t,__reflect(t.prototype,"game.Food")}(game||(game={}));var game;!function(e){var t;!function(t){var n=function(t){function n(e){var n=t.call(this)||this;return n.data=e,n.touchEnabled=!1,n.subRenderers=[],n.subBlendRenderers=[],n.txtName=new egret.TextField,n.txtName.textColor=n.data.color,n.txtName.text=n.data.name,n}return __extends(n,t),n.prototype.prepareSubRenderer=function(t,n){if(this.subRenderers.length<n||!this.subRenderers[n]){var a=ObjectPool.get(egret.Sprite);a.graphics.beginFill(t.color),a.graphics.drawCircle(0,0,e.Snake.BODY_SIZE),a.graphics.endFill(),a.alpha=1,a.blendMode=egret.BlendMode.NORMAL,this.subRenderers[n]=a;var i=ObjectPool.get(egret.Sprite);i.graphics.beginFill(t.color),i.graphics.drawCircle(0,0,e.Snake.BODY_SIZE),i.graphics.endFill(),i.blendMode=egret.BlendMode.ADD,i.alpha=1,this.subBlendRenderers[n]=i}},n.prototype.removeSubRenderer=function(e){var t=this.subRenderers[e];this.subRenderers[e]=null,t&&(ObjectPool.release(egret.Sprite,t),t.parent&&t.parent.removeChild(t)),t=this.subBlendRenderers[e],this.subBlendRenderers[e]=null,t&&(ObjectPool.release(egret.Sprite,t),t.parent&&t.parent.removeChild(t))
},n.prototype.render=function(){var t,n,a=this.data,i=this.data.points[0],r=0;a.isInView?(this.txtName.parent||GameLayerManager.getInstance().underUILayer.addChild(this.txtName),this.txtName.x=i.x,this.txtName.y=i.y):this.txtName.parent&&this.txtName.parent.removeChild(this.txtName);for(var s=this.data.points.length-1;s>=0;s--)if(i=this.data.points[s],i.isInView)if(this.prepareSubRenderer(i,s),t=this.subRenderers[s],t.scaleX=a.scale,t.scaleY=a.scale,t.x=i.x,t.y=i.y,t.parent?a.hasViewStateChanged&&t.parent.setChildIndex(t,r):this.addChildAt(t,r),r++,n=this.subBlendRenderers[s],a.velocity==e.Snake.VELOCITY_FAST){var o=Math.abs(-e.Time.frameCount+s)%40;o=o>20?40-o:o,n.alpha=o/20*.4,n.scaleX=1.1*a.scale,n.scaleY=1.1*a.scale,n.x=i.x,n.y=i.y,n.parent||GameLayerManager.getInstance().snakeBlendLayer.addChild(n)}else n.parent&&n.parent.removeChild(n);else this.removeSubRenderer(s);for(var s=this.data.points.length;s<this.subRenderers.length;s++)this.removeSubRenderer(s);a.hasViewStateChanged=void 0},n}(egret.DisplayObjectContainer);t.SnakeRenderer=n,__reflect(n.prototype,"game.renderer.SnakeRenderer")}(t=e.renderer||(e.renderer={}))}(game||(game={}));var game;!function(e){var t=function(){function e(){}return e.resize=function(e,t){this.stageWith=e,this.stageHeight=t},e.update=function(){var t=GameObjectManager.getInstance().player,n=GameLayerManager.getInstance().scene;if(t&&n){var a=t.position.x-.5*this.stageWith,i=t.position.y-.5*this.stageHeight;n.x=-a,n.y=-i,this.viewPortMinX=a-e.VIEW_PORT_EXTENSION,this.viewPortMaxX=a+this.stageWith+e.VIEW_PORT_EXTENSION,this.viewPortMinY=i-e.VIEW_PORT_EXTENSION,this.viewPortMaxY=i+this.stageHeight+e.VIEW_PORT_EXTENSION,this.viewPortRect=this.viewPortRect?this.viewPortRect:new egret.Rectangle,this.viewPortRect.setTo(this.viewPortMinX,this.viewPortMinY,this.viewPortMaxX-this.viewPortMinX,this.viewPortMaxY-this.viewPortMinY),this.viewPortCenterX=.5*(this.viewPortMaxX+this.viewPortMinX),this.viewPortCenterY=.5*(this.viewPortMaxY+this.viewPortMinY)}},e.isInViewPort=function(e){if(e instanceof egret.Rectangle){var t=.5*(e.right+e.left),n=.5*(e.bottom+e.top);return Math.abs(this.viewPortCenterX-t)<=.5*this.viewPortRect.width+.5*e.width&&Math.abs(this.viewPortCenterY-n)<=.5*this.viewPortRect.height+.5*e.height}return e instanceof egret.Point?this.viewPortRect.containsPoint(e):void console.error("[isInViewPort]param1 is unsupport type:"+e)},e.VIEW_PORT_EXTENSION=WorldNode.SIDE_LENGTH,e}();e.Camera=t,__reflect(t.prototype,"game.Camera")}(game||(game={}));var DebugPlatform=function(){function e(){}return e.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,{nickName:"username"}]})})},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})},e}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var game;!function(e){var t;!function(e){var t=function(){function e(){}return e.clamp=function(e,t,n){return Math.max(t,Math.min(n,e))},e.lerp=function(e,t,n){return e+(t-e)*n},e}();e.MathUtils=t,__reflect(t.prototype,"game.utils.MathUtils")}(t=e.utils||(e.utils={}))}(game||(game={}));var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.createView(),t}return __extends(t,e),t.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},t.prototype.onProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);